## Zookeeper
Zookeeper是一个开源的**分布式协调服务**。Zookeeper是一个典型的分布式数据一致性解决方案，分布式应用程序可以基于Zookeeper实现诸如**数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master选举、分布式锁和分布式队列**等功能。

Zookeeper一个最常用的使用场景就是用于担任服务生产者和服务消费者的注册中心。服务生产者将自己提供的服务注册到Zookeeper中心，服务的消费者在进行服务调用的时候先**到Zookeeper中查找服务**，获取到服务生产者的详细信息之后，再去调用服务生产者的内容和数据。在Dubbo的架构中，Zookeeper就担任了注册中心这一角色。

## 应用场景
* 配置管理：如果我们做普通的 Java 应用，一般配置项就是一个本地的配置文件，如果是微服务系统，各个独立服务都要使用集中化的配置管理，这个时候就需要 ZooKeeper。
* DNS服务：用来管理多个服务的域名和IP地址的对应关系。
* 分布式锁：在某个时刻，只让一个服务去完成某个功能，当这个服务出问题的时候，锁释放，让另外的服务来完成这个功能。
* 集群管理：


### 重要概念
* Zookeeper本身就是一个**分布式程序**（只要半数以上的节点存活，Zookeeper就能正常服务）
* 为了保证高可用，最好是以**集群形态**来部署Zookeeper，这样只要集群中大部分机器是可用的（能够容忍一定的机器故障），那么Zookeeper本身仍然是可用的。
* Zookeeper将**数据保存在内存中**，这也就保证了**高吞吐量和低延迟**（但是内存限制了**能够存储的容量不大**，此限制也是保持znode中存储的数据量较小的进一步原因）。
* Zookeeper是**高性能**的。在**读多于写**的应用程序中尤其的高性能，因为写会导致所有的服务器间同步状态。（读多于写是协调服务的典型场景）
* Zookeeper有**临时节点**的概念。当创建临时节点的客户端绘画一直保持活动，临时节点就一直存在。而当会话终结时，临时节点被删除。**持久节点**是指一旦这个ZNode被创建了，除非主动进行的ZNode的移除操作，否则这个ZNode将一直保存在Zookeeper上。
* Zookeeper底层其实只提供了两个功能：管理（存储、读取）用户程序提交的数据，为用户程序提交数据节点监听服务。


## 会话（Session）
Session指的是**Zookeeper服务器与客户端会话**。在Zookeeper中，一个客户端连接是指**客户端和服务器之间的一个TCP长连接**。客户端启动的时候，首先会与服务器建立一个TCP连接，从第一次连接建立开始，客户端会话的生命周期也开始了。通过这个连接，客户端能够通过心跳检测与服务器保持有效的会话，也能够向Zookeeper服务器发送请求并接受相应，同时还能够通过该连接接收来自服务器的Watch事件通知。Session的**sessionTimeout**值用来设置一个客户端会话的超时时间。当由于服务器压力太大、网络故障或是客户端主动断开连接等各种原因导致客户端连接断开时，只要在sessionTimeout规定的时间内能够重新连接上集群中任意一台服务器，那么之前创建的会话仍然有效。

在为客户端创建会话之前，服务端首先会为每个客户端都分配一个sessionID，由于sessionID是Zookeeper会话的一个重要标识，许多与会话相关的运行机制都是基于这个sessionId的，因此，无论是哪台服务器为客户端分配的sessionID，都务必保证全局唯一。

## Znode
在谈到分布式的时候，我们通常说的节点是指组成集群的每一台机器。然而，在Zookeeper中，节点分为两类，第一类同样是**构成集群的机器，称为机器节点**；第二类是指**数据模型中的数据单元，称为数据节点————ZNode**。

Zookeeper将所有的数据存储在内存中，数据模型是一棵树（Znode Tree），由  /  进行分割路径，就是一个Znode，如/foo/path。每个节点上都会保存自己的数据内容，同时还会保存一系列属性信息。

<img src=./img/Zookeeper存储结构.jpg>

### 节点类型
* PERSISTENT 持久化节点: 所谓持久节点，是指在节点创建后，就一直存在，直到有删除操作来主动清除这个节点。否则不会因为创建该节点的客户端会话失效而消失。

* PERSISTENT_SEQUENTIAL 持久顺序节点：这类节点的基本特性和上面的节点类型是一致的。额外的特性是，在ZK中，每个父节点会为他的第一级子节点维护一份时序，会记录每个子节点创建的先后顺序。基于这个特性，在创建子节点的时候，可以设置这个属性，那么在创建节点过程中，ZK 会自动为给定节点名加上一个数字后缀，作为新的节点名。这个数字后缀的范围是整型的最大值。 在创建节点的时候只需要传入节点 “/test_”，这样，zookeeper自动会给”test_”后面补充数字。

* EPHEMERAL 临时节点：和持久节点不同的是，临时节点的生命周期和客户端会话绑定。也就是说，如果客户端会话失效，那么这个节点就会自动被清除掉。注意，这里提到的是会话失效，而非连接断开。另外，在临时节点下面不能创建子节点。这里还要注意一件事，就是当你客户端会话失效后，所产生的节点也不是一下子就消失了，也要过一段时间，大概是 10 秒以内，可以试一下，本机操作生成节点，在服务器端用 命令来查看当前的节点数目，你会发现客户端已经 stop，但是产生的节点还在。

## 特点
* **顺序一致性**：从同一客户端发起的事务请求，最终将会严格的按照顺序被应用到Zookeeper中去。
* **原子性**：所有的事物请求的处理结果在整个集群中所有的机器上的应用情况是一致的，也就是说，要么整个集群中所有的机器都应用了某一个事务，要么都没有应用。
* **单一系统映像**：无论客户端连接到哪一个Zookeeper服务器上，其看到的服务端数据模型都是一致的。
* **可靠性**：一旦一次更改请求被应用，更改的结果就会被持久化，直到下一次被覆盖。