消息队列（Message Queue），顾名思义就是一个存放消息的队列，此处的消息一般为要传递的数据。其中向消息队列中存放数据的叫做**生产者**，从消息队列中取出数据的叫**消费者**。消息队列是分布式系统中重要的组件，目前使用较多的消息队列有ActiveMQ，RabbitMQ，Kafka，RocketMQ。

## 消息队列的好处
1. 解耦：解除系统模块之间的耦合，一个生产者产生数据，一个或多个消费者使用这个数据，如果不使用消息队列，模块之间需要直接产生关系，例如使用接口，此时如果一个模块发生变化，其他模块也要跟着变化，耦合程度较高。如果使用消息队列，生产者只负责把数据写入消息队列中，消费者只负责从消息队列中取数据，解除了这些模块之间的耦合。
2. 异步：把非主要的业务异步处理，提高了系统响应的时间。
3. 削峰/限流：高并发场景下，如果请求过多超过了系统的处理极限，那么系统就会崩溃。此时可以把请求放入消息队列中，系统根据自己的需求从消息队列中取数据，这样就不会把系统搞崩溃。

## 消息队列带来的问题
1. 系统可用性降低：系统可用性在某种程度上降低，为什么这样说呢？在加入MQ之前，你不用考虑消息丢失或者说MQ挂掉等等的情况，但是引入MQ之后你就需要去考虑这些问题了。
2. 一致性问题：消息队列的异步可能会带来系统的一致性问题。


# JMS  AMQP
## JMS
JMS（JAVA Message Service,Java消息服务）是java的消息服务，JMS的客户端之间可以通过JMS服务进行异步的消息传输。JMS API是一个消息服务的标准或者说是规范，允许应用程序组件基于JavaEE平台创建、发送、接收和读取消息。它使分布式通信耦合度更低，消息服务更加可靠以及异步性。ActiveMQ 就是基于 JMS 规范实现的。

### JMS的消息模型
1. **点到点（P2P）模型**：使用**队列（Queue）作为消息通信载体**；满足生产者与消费者模式，一条消息只能被一个消费者使用，未被消费的消息在队列中保留直到被消费或超时。比如：我们生产者发送100条消息的话，两个消费者来消费一般情况下两个消费者会按照消息发送的顺序各自消费一半（也就是你一个我一个的消费。）
<br><img src=img/点对点模型.jpg><br>

2. **发布订阅模型（Pub/Sub）**： 使用**主题（Topic）作为消息通信载体**，类似于广播模式；发布者发布一条消息，该消息通过主题传递给所有的订阅者，在一条消息广播之后才订阅的用户则是收不到该条消息的。
<br><img src=img/发布订阅模型.jpg><br>

### JMS的消息格式
JMS定义了五种不同的消息正文格式，以及调用的消息类型，允许你发送并接收一些不同形式的数据。
* StreamMessage -- Java原始值的数据流
* MapMessage--一套名称-值对
* TextMessage--一个字符串对象
* ObjectMessage--一个序列化的 Java对象
* BytesMessage--一个字节的数据流

## AMQP
AMQP，即Advanced Message Queuing Protocol,一个提供统一消息服务的应用层标准**高级消息队列协议**（二进制应用层协议），是应用层协议的一个开放标准，为面向消息的中间件设计，兼容JMS。基于此协议的客户端与消息中间件可传递消息，并不受客户端/中间件同产品，不同的开发语言等条件的限制。RabbitMQ 就是基于 AMQP 协议实现的。

AMQP提供了**五种消息模型**：①direct exchange；②fanout exchange；③topic change；④headers exchange；⑤system exchange。本质来讲，后四种和JMS的pub/sub模型没有太大差别，仅是在路由机制上做了更详细的划分。

AMQP**只支持二进制的数据类型**。


## 总结
|对比方向|JMS     |AMQP|
|:---  |:----    |:----|
|定义   |Java API|协议|
|跨语言|否 |     是|
|跨平台|否  |     是|
|消息模型|两种 |   五种|
|消息类型|多种类型| 只支持二进制类型|

* AMQP 为消息定义了线路层（wire-level protocol）的协议，而JMS所定义的是API规范。在 Java 体系中，多个client均可以通过JMS进行交互，不需要应用修改代码，但是其对跨平台的支持较差。而AMQP天然具有跨平台、跨语言特性。
* JMS 支持TextMessage、MapMessage 等复杂的消息类型；而 AMQP 仅支持 byte[] 消息类型（复杂的类型可序列化后发送）。
* 由于Exchange 提供的路由算法，AMQP可以提供多样化的路由方式来传递消息到消息队列，而 JMS 仅支持 队列 和 主题/订阅 方式两种。

# 常见消息队列对比
* **吞吐量**：万级：ActiveMQ 和 RabbitMQ（ActiveMQ最差）；十万级：RocketMQ 和 Kafka。
* **可用性**：都可以实现高可用，ActiveMQ 和 RabbitMQ 都是**基于主从架构**实现高可用性。RocketMQ 和kafka **基于分布式架构**，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用。
* **时效性**：RabbitMQ 基于erlang开发，所以并发能力很强，性能极其好，延时很低，达到**微秒级**。其他三个都是 ms 级。
* **消息丢失**：ActiveMQ 和 RabbitMQ 丢失的可能性非常低， RocketMQ 和 Kafka 理论上不会丢失。

<br><img src=img/对比.png><br>
